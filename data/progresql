-- 建立資料庫
-- CREATE DATABASE platform;
-- \c platform;

-- 建立 enum 類型
CREATE TYPE resource_type AS ENUM ('pod','service','deployment','configmap','ingress');
CREATE TYPE user_type AS ENUM ('origin','oauth2');
CREATE TYPE user_status AS ENUM ('online','offline','delete');
CREATE TYPE user_role AS ENUM ('admin','manager','user');

-- group_list
CREATE TABLE group_list (
  g_id SERIAL PRIMARY KEY,
  group_name VARCHAR(100) NOT NULL,
  description TEXT,
  create_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  update_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- project
CREATE TABLE project (
  p_id SERIAL PRIMARY KEY,
  project_name VARCHAR(100) NOT NULL,
  description TEXT,
  g_id INTEGER NOT NULL REFERENCES group_list(g_id) ON DELETE CASCADE ON UPDATE CASCADE,
  create_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  update_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- resource
CREATE TABLE resource (
  r_id SERIAL PRIMARY KEY,
  type resource_type NOT NULL,
  name VARCHAR(50) NOT NULL,
  filename VARCHAR(200) NOT NULL,
  description TEXT,
  p_id INTEGER NOT NULL REFERENCES project(p_id) ON DELETE CASCADE ON UPDATE CASCADE,
  create_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  update_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- users
CREATE TABLE users (
  u_id SERIAL PRIMARY KEY,
  username VARCHAR(50) NOT NULL,
  password VARCHAR(255) NOT NULL,
  email VARCHAR(100),
  full_name VARCHAR(50),
  type user_type NOT NULL DEFAULT 'origin',
  status user_status NOT NULL DEFAULT 'offline',
  create_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  update_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- user_group
CREATE TABLE user_group (
  u_id INTEGER NOT NULL,
  g_id INTEGER NOT NULL,
  role user_role NOT NULL DEFAULT 'user',
  create_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  update_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (u_id, g_id),
  FOREIGN KEY (u_id) REFERENCES users(u_id) ON DELETE CASCADE ON UPDATE CASCADE,
  FOREIGN KEY (g_id) REFERENCES group_list(g_id) ON DELETE CASCADE ON UPDATE CASCADE
);

-- audit_logs
CREATE TABLE audit_logs (
    id SERIAL PRIMARY KEY,                         -- Primary key
    user_id INT NOT NULL,                          -- ID of the user performing the action
    action VARCHAR(20) NOT NULL,                   -- Action type, e.g. 'create', 'update', 'delete'
    resource_type VARCHAR(50) NOT NULL,            -- Type of resource, e.g. 'group', 'user', 'project'
    resource_id INT NOT NULL,                       -- ID of the target resource
    old_data JSONB,                                -- Data before the action (nullable)
    new_data JSONB,                                -- Data after the action (nullable)
    ip_address VARCHAR(45),                        -- IP address of the actor (supports IPv6)
    user_agent TEXT,                               -- User agent string of client
    description TEXT,                              -- Additional notes or description (e.g. reason for action)
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL -- Timestamp of the action with timezone
);

-- View: project_group_view
CREATE OR REPLACE VIEW project_group_views AS
SELECT
  g.g_id,
  g.group_name,
  COUNT(DISTINCT p.p_id) AS project_count,
  COUNT(r.r_id) AS resource_count,
  MAX(g.create_at) AS group_create_at,
  MAX(g.update_at) AS group_update_at
FROM group_list g
LEFT JOIN project p ON p.g_id = g.g_id
LEFT JOIN resource r ON r.p_id = p.p_id
GROUP BY g.g_id, g.group_name;

-- View: project_resource_view
CREATE OR REPLACE VIEW project_resource_views AS
SELECT
  p.p_id,
  p.project_name,
  r.r_id,
  r.type,
  r.name,
  r.filename,
  r.create_at AS resource_create_at,
  r.update_at AS resource_update_at
FROM project p
JOIN resource r ON r.p_id = p.p_id;

-- View: user_group_view
CREATE OR REPLACE VIEW user_group_views AS
SELECT
  u.u_id,
  u.username,
  g.g_id,
  g.group_name,
  ug.role
FROM users u
JOIN user_group ug ON u.u_id = ug.u_id
JOIN group_list g ON ug.g_id = g.g_id;

-- View: users_with_superadmin
CREATE OR REPLACE VIEW users_with_superadmin AS
SELECT
  u.u_id,
  u.username,
  u.password,
  u.email,
  u.full_name,
  u.type,
  u.status,
  u.create_at,
  u.update_at,
  CASE WHEN ug.role = 'admin' AND ug.group_name = 'super' THEN true ELSE false END AS is_super_admin
FROM users u
LEFT JOIN user_group_views ug ON u.u_id = ug.u_id AND ug.group_name = 'super' AND ug.role = 'admin';

-- -- Initialize
INSERT INTO group_list (group_name, description)
VALUES ('super', 'Super administrator group');

-- INSERT INTO users (username, password, type, status, full_name, email)
-- VALUES ('admin', 'admin123', 'origin', 'offline', 'Administrator', '');

-- INSERT INTO user_group (u_id, g_id, role)
-- SELECT u.u_id, g.g_id, 'admin'
-- FROM users u, group_list g
-- WHERE u.username = 'admin' AND g.group_name = 'super';